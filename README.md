# JKali Patches associated with Travis CI builds having only one failing test case

This is an open-science repository that collects the Kali patches generated by [Repairnator](https://github.com/eclipse/repairnator) during the analysis of the Travis CI builds characterised by only one failing test case and no test cases with errors.

This repository aims to contain the code of the failing Java projects and to analyze the Kali patches generated using [AstorJKali](https://github.com/SpoonLabs/astor#jkali).

## Content of the repository

The structure of the repository is as follows:

- Branch `master` contains the `jkali-patches` folder and the documentation of this repository;
- The `jkali-patches` folder contains the patches generated by Repairnator (using the `AstorJKali` repair mode) analyzing the Travis CI build failure related to Java programs that use Maven as building tool;
- For each of these failing builds, there is a specific branch with all the information related to the building of the project, bug reproduction, failing tests and repair attempts.

## Statistics

There are currently 1.683 (excluding `master` branch) branches, each of them associated with a failure, and there are 72 Kali patches.

## Patch Analysis

### EnMasseProject-enmasse-353457987-20180314-185443

- **Branch associated with the failure**: [repairnator-repairnator-experiments-EnMasseProject-enmasse-353457987-20180314-185443-firstCommit](https://github.com/repairnator/repairnator-experiments-jkali-one-failing-test-case/tree/repairnator-repairnator-experiments-EnMasseProject-enmasse-353457987-20180314-185443-firstCommit).

- **Information about the failure**:

| Failure type | Failing test case | Changed file by AstorJKali |
|--------------|-------------------|----------------------------|
| org.mockito.exceptions.verification.TooLittleActualInvocations | [FifoQueueTest.java](https://github.com/repairnator/repairnator-experiments-jkali-one-failing-test-case/blob/733c76e58890cea2d4ce004760de719ae04ca826/k8s-api/src/test/java/io/enmasse/k8s/api/cache/FifoQueueTest.java#L64) | [FifoQueue.java](https://github.com/repairnator/repairnator-experiments-jkali-one-failing-test-case/blob/733c76e58890cea2d4ce004760de719ae04ca826/k8s-api/src/main/java/io/enmasse/k8s/api/cache/FifoQueue.java#L54)|

- **Kali patch**:

```diff
--- /src/main/java/io/enmasse/k8s/api/cache/FifoQueue.java
+++ /src/main/java/io/enmasse/k8s/api/cache/FifoQueue.java
@@ -44,7 +44,6 @@
 			return;
 		}
 		java.util.List<io.enmasse.k8s.api.cache.FifoQueue.Event<T>> events = new java.util.ArrayList<>();
-		queue.drainTo(events);
 		java.lang.String key = null;
 		if (event.obj != null) {
 			key = keyExtractor.getKey(event.obj);
```

- **Analysis of the patch**: the problem is related to the test case that checks the correct behavior of the [method](https://github.com/repairnator/repairnator-experiments-jkali-one-failing-test-case/blob/733c76e58890cea2d4ce004760de719ae04ca826/k8s-api/src/main/java/io/enmasse/k8s/api/cache/FifoQueue.java#L46) changed by AstorJKali. Indeed, looking at the commit history of the project, the developer [changed the test case](https://github.com/EnMasseProject/enmasse/pull/1058/commits/848ff42b0ed3fa5888778957ac8daca909c98072) to handle the error associated with the use of method `draintTo`, that is the method removed by AstorJKali to create the patch.
- **Useful information for the developer**: the Kali patch suggested that there was a problem with the method `drainTo` or with the test case `testRemove` that checks the behavior of that method. In this case, since the method `drainTo` is a method of the JDK, there is more probability that the error is not related to that method, but in the way used to test it. Thus, the developer can start to analyze the problem focusing on the test case, checking if it is correct or not.

- **Fix of the test case**:

```diff
From 848ff42b0ed3fa5888778957ac8daca909c98072 Mon Sep 17 00:00:00 2001
From: Ulf Lilleengen <lulf@redhat.com>
Date: Wed, 14 Mar 2018 20:29:54 +0100
Subject: [PATCH] Fix test to handle drain

---
 .../src/test/java/io/enmasse/k8s/api/cache/FifoQueueTest.java   | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/k8s-api/src/test/java/io/enmasse/k8s/api/cache/FifoQueueTest.java b/k8s-api/src/test/java/io/enmasse/k8s/api/cache/FifoQueueTest.java
index 213c76fef1..ec7b7fda7f 100644
--- a/k8s-api/src/test/java/io/enmasse/k8s/api/cache/FifoQueueTest.java
+++ b/k8s-api/src/test/java/io/enmasse/k8s/api/cache/FifoQueueTest.java
@@ -61,7 +61,7 @@ public void testRemove() throws Exception {
         assertTrue(queue.list().isEmpty());
 
         queue.pop(mockProc, 0, TimeUnit.SECONDS);
-        verify(mockProc, times(2)).process(eq("k1"));
+        verify(mockProc).process(eq("k1"));
         assertTrue(queue.listKeys().isEmpty());
         assertTrue(queue.list().isEmpty());
     }
```

### Inmapg-Text-Traffic-Simulator-368867994-20180419-235104

- **Branch associated with the failure**: [repairnator-repairnator-experiments-Inmapg-Text-Traffic-Simulator-368867994-20180419-235104-firstCommit](https://github.com/repairnator/repairnator-experiments-jkali-one-failing-test-case/tree/repairnator-repairnator-experiments-Inmapg-Text-Traffic-Simulator-368867994-20180419-235104-firstCommit).

- **Information about the failure**:

| Failure type | Failing test case | Changed file by AstorJKali |
|--------------|-------------------|----------------------------|
| java.lang.AssertionError | [VehicleTest.java](https://github.com/repairnator/repairnator-experiments-jkali-one-failing-test-case/blob/af902a319926cfcbb772fbc6913f0a8112987129/src/test/java/pr5/tmodel/VehicleTest.java#L115) | [IniSection.java](https://github.com/repairnator/repairnator-experiments-jkali-one-failing-test-case/blob/af902a319926cfcbb772fbc6913f0a8112987129/src/main/java/pr5/ini/IniSection.java#L176)|

- **Kali patch**:

```diff
--- /src/main/java/pr5/ini/IniSection.java
+++ /src/main/java/pr5/ini/IniSection.java
@@ -85,7 +85,6 @@
 		}
 		for (java.lang.String key : this.getKeys()) {
 			if (!this.getValue(key).equals(other.getValue(key))) {
-				return false;
 			}
 		}
 		return true;
```

- **Analysis of the patch**: the problem is related to the test case that checks the correct behavior of the [method](https://github.com/repairnator/repairnator-experiments-jkali-one-failing-test-case/blob/af902a319926cfcbb772fbc6913f0a8112987129/src/main/java/pr5/ini/IniSection.java#L159) changed by AstorJKali. Indeed, looking at the commit history of the project, the developer [changed the test case](https://github.com/Inmapg/Traffic-Simulator/commit/e59608185c3f326d46eb82371614d5ee354a9ba9) to handle the failure during the comparison of two `Vehicle` objects.
- **Useful information for the developer**: the Kali patch suggested that there was a problem with the method `equals` or with the test case `VehicleFaultyTest` that checks the behavior of that method.

- **Fix of the test case**:

```diff
From e59608185c3f326d46eb82371614d5ee354a9ba9 Mon Sep 17 00:00:00 2001
From: Inma <Inma@eduroam162180.eduroam.ucm.es>
Date: Thu, 19 Apr 2018 23:54:13 +0200
Subject: [PATCH] Fixing VehicleTest class

---
 src/test/java/pr5/tmodel/VehicleTest.java | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/test/java/pr5/tmodel/VehicleTest.java b/src/test/java/pr5/tmodel/VehicleTest.java
index 2248632..ca127a5 100755
--- a/src/test/java/pr5/tmodel/VehicleTest.java
+++ b/src/test/java/pr5/tmodel/VehicleTest.java
@@ -109,7 +109,7 @@ public void VehicleFaultyTest(){
         assertEquals(correct, result);
         vehicle.makeFaulty(2);
         correct.setValue("time", "2");
-        correct.setValue("speed", "10");
+        correct.setValue("speed", "0");
         correct.setValue("faulty", "2");
         result = vehicle.generateReport(2);
         assertEquals(correct, result);
```
