<!DOCTYPE html>
<!--
Copyright (C) 2016 Max Planck Institute for Psycholinguistics

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-->
<!--
 * @since Mar 4, 2016 11:23:23 AM (creation date)
 * @author Peter Withers <peter.withers@mpi.nl>
-->
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Frinex Experiment Wizard</title>
        <link rel="stylesheet" type="text/css" href="/ExperimentDesigner/designer.css"/>
    </head>
    <body>
        <div th:fragment="wizardlisting">
            <table id="wizardlisting" class="presenter">
                <thead>
                    <tr>
                        <th>Experiment Name</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="clickablerow" th:each="wizardData : ${wizardList}" th:onclick="'javascript:window.location=\'wizard/edit/' + ${wizardData.getId()} + '\';'">
                        <td th:text="${wizardData.getAppName()}"></td>
                        <td th:text="${wizardData.getWizardScreens().size()}"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div th:fragment="wizardstart">
            <script th:inline="javascript">
                /*<![CDATA[*/
                function validateForm() {
                    if ($("#experimentName").val() === "") {
                        $("#errorMessage").html("experiment name cannot be blank");
                        return false;
                    }
                    if ($.inArray($("#experimentName").val(), /*[[${existingWizardList}]]*/) > -1) {
                        $("#errorMessage").html("experiment name must be unique");
                        return false;
                    }
                }
                /*]]>*/
            </script>
            <div class="presenter">
                <form action="#" th:action="${contextPath + '/wizard/create'}" onsubmit="return validateForm()" method="post">
                    <div class="featurescell wizardrow">
                        <span class="wizardcell">Experiment Name</span><input class="wizardgrowcell" type="text" name="experimentName" id="experimentName" />
                        &nbsp;<div id="errorMessage" class="errorDiv"></div>
                    </div>
                    <div class="featurescell wizardrow">
                        <span class="wizardcell">Template</span>
                        <select class="wizardcell" name="templateName" id="templateName" >
                            <option th:each="templateName : ${templateList}" th:text="${templateName}" th:value="${templateName}"></option>
                        </select>
                    </div>
                    <div class="featurescell wizardrow">
                        <button type="submit" name="saveExperiment">Start Wizard</button>                
                    </div>
                </form>
            </div>  
        </div>
        <div th:fragment="wizardedit">
            <table class="presenter">
                <tr>
                    <td>Experiment Name</td>
                    <td>
                        <input th:value="${wizardData.appName}" class="wizardgrowcell" th:name="${wizardFragmentName}" th:onchange="${'$(updateExperimentButton' + wizardData.getId() + ').show();'}" />
                    </td>
                </tr>
                <tr>
                    <td>Obfuscate Screen Names</td>
                    <td>
                        <input type="checkbox" th:checked="${wizardData.obfuscateScreenNames}" class="wizardgrowcell" th:name="obfuscateScreenNames" th:onchange="${'$(updateExperimentButton' + wizardData.getId() + ').show();'}" />
                    </td>
                </tr>
                <tr>
                    <td>Show Menu Bar</td>
                    <td>
                        <input type="checkbox" th:checked="${wizardData.showMenuBar}" class="wizardgrowcell" th:name="showMenuBar" th:onchange="${'$(updateExperimentButton' + wizardData.getId() + ').show();'}" />
                    </td>
                </tr>
                <tr>
                    <td>Text Font Size</td>
                    <td>
                        <input type="number" th:value="${wizardData.textFontSize}" class="wizardgrowcell" th:name="textFontSize" th:onchange="${'$(updateExperimentButton' + wizardData.getId() + ').show();'}" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <form action="#" th:action="${contextPath + '/wizard/json/' + wizardData.getId()}" method="get">
                            <button type="submit">View JSON</button>
                        </form>
                    </td><td>
                        <form action="#" th:action="${contextPath + '/experiments/wizard/create/' + wizardData.getId()}" method="get">
                            <button type="submit" name="saveExperiment">Create Experiment</button>
                        </form>
                    </td>
                </tr>
            </table>  
            <!--            <ul id="wizardScreenList" class="presenter">
                            <li th:each="wizardScreen : ${wizardData.getWizardScreens()}" th:fragment="wizardScreenForm"
                                th:id="${'updateWizardForm' + wizardScreen.getScreenTag()}"
                                draggable="true"
                                ondragstart="drag(event)"
                                ondrop="drop(event)" 
                                ondragover="allowDrop(event)"
                                class="wizardScreenPanel featurestable">
                                <div class="errorDiv"/>
                                <form class="eaturesrow">
                                    <div class="featureTypeHeader">
                                        <span>screenTitle</span><input name="screenTitle" th:value="${wizardScreen.getScreenTitle()}" /><br/>
                                    </div>
                                    
                                </form>
                            </li>
                        </ul>-->
            <div class="table">
                <div th:each="wizardScreen : ${wizardData.getWizardScreens()}" th:fragment="wizardScreenForm">
                    <div th:fragment="wizardScreenForms">    
                        <div class="featurestable">
                            <div>
                                <div th:fragment="featuresrow" class="featuresrow">
                                    <div th:id="${'wizardScreenForm' + wizardScreen.screenTag}">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                        <div class="featureTypeHeader"
                                             th:id="${'wizardScreenHeader' + wizardScreen.getScreenTag()}"
                                             draggable="true"
                                             ondragstart="drag(event)"
                                             ondrop="drop(event)" 
                                             ondragover="allowDrop(event)">
                                            <button class="deleteFeatureButton" type="button" th:onclick="${'deleteFeature(featureForm' + wizardScreen.screenTag + ')'}">Delete Screen</button>
                                            <!--<span class="featureTypeLabel" th:text="${wizardScreen.class.name}">wizardScreen.class.name</span>-->
                                            <span class="featureTypeLabel"><input name="screenTitle" th:value="${wizardScreen.getScreenTitle()}" /></span>
                                            <select name="backWizardScreenId" th:onchange="${'$(updateFeatureButton' + wizardScreen.id + ').show();'}">
                                                <option value="-1">&lt;none&gt;</option>
                                                <option th:each="wizardScreenItem : ${wizardData.getWizardScreens()}" th:value="${wizardScreenItem.id}" th:text="${wizardScreenItem.screenTitle}" th:selected="${wizardScreenItem.equals(wizardScreen.backWizardScreenData)}" />
                                            </select>
                                            <select name="nextWizardScreenId" th:onchange="${'$(updateFeatureButton' + wizardScreen.id + ').show();'}">
                                                <option value="-1">&lt;none&gt;</option>
                                                <option th:each="wizardScreenItem : ${wizardData.getWizardScreens()}" th:value="${wizardScreenItem.id}" th:text="${wizardScreenItem.screenTitle}" th:selected="${wizardScreenItem.equals(wizardScreen.nextWizardScreenData)}" />
                                            </select>
                                            <button type="button" style="display: none" th:id="${'updateFeatureButton' + wizardScreen.id}" class="saveFeatureButton" th:onclick="${'postFeatureChanges(featureForm' + wizardScreen.id + ')'}">Save Changes</button>
                                        </div>
                                        <div class="errorDiv"/>                                        
                                        &nbsp;<span class="wizardScreenDetailsCheckBox"><input type="checkbox" checked="true" th:id="${'wizardScreenDetailsCheckBox' + wizardScreen.screenTag}" th:onclick="'hideShowDetails(\''+${wizardScreen.screenTag}+'\')'">Show details</input></span>
                                        <div class="featurescell" th:id="${'wizardScreenDetails' + wizardScreen.screenTag}">
                                            <div class="featuresrow featurescell">
                                                <table>
                                                    <tr>
                                                        <td>Screen Title</td>
                                                        <td>Menu Label</td>
                                                        <td>Screen Tag</td>
                                                    </tr>
                                                    <tr>
                                                        <td><input name="screenTitle" th:value="${wizardScreen.screenTitle}" /></td>
                                                        <td><input name="menuLabel" th:value="${wizardScreen.menuLabel}" /></td>
                                                        <td><input name="screenTag" th:value="${wizardScreen.screenTag}" /></td>
                                                    </tr>
                                                </table>
                                            </div>
                                            <br/>
                                            <div class="featuresrow featurescell" th:if="${!wizardScreen.getMetadataFields().isEmpty()}" th:include="metadata :: metadatashorttable(updatedMetadata=${wizardScreen.getMetadataFields()}, wizardScreenId=${wizardScreen.getId()})"></div>
                                            <div class="">
                                                <!--                                                private final WizardScreenEnum wizardScreenType;
                                                
                                                    @OneToOne(targetEntity = WizardScreenData.class, cascade = CascadeType.ALL)
                                                    private WizardScreenData backWizardScreenData = null;
                                                    @OneToOne(targetEntity = WizardScreenData.class, cascade = CascadeType.ALL)
                                                    private WizardScreenData nextWizardScreenData = null;
                                                    @OneToOne(targetEntity = WizardScreenData.class, cascade = CascadeType.ALL)
                                                    private ArrayList<WizardScreenData> menuWizardScreenData = new ArrayList<>();
                                                    @Size(max = 6000)
                                                    private ArrayList<String> screenText = new ArrayList<>();
                                                    private String[] nextButton = null;
                                                    private String screenTitle = null;
                                                    private String menuLabel = null;
                                                    private String screenTag = null;
                                                    private Boolean centreScreen = null;
                                                    private Boolean stimulusFreeText = null;
                                                    private String freeTextValidationRegex = null;
                                                    private String freeTextValidationMessage = null;
                                                    private Boolean sendData = null;
                                                    private Boolean filePerStimulus = null;
                                                
                                                    @OneToMany(cascade = CascadeType.ALL, orphanRemoval = true, fetch = FetchType.LAZY)
                                                    private List<Stimulus> stimuli = null;
                                                
                                                    private String[] stimuliRandomTags = null;
                                                    private String screenMediaPath = null;
                                                    private Integer stimulusMsDelay = null;
                                                    private String stimulusCodeMatch = null;
                                                    private Integer stimulusCodeMsDelay = null;
                                                    private String stimulusCodeFormat = null;
                                                    private Boolean randomiseStimuli = null;
                                                    private Integer stimuliCount = null;
                                                    private Integer repeatCount = null;
                                                    private Integer repeatRandomWindow = null;
                                                    private String buttonLabelEventTag = null;
                                                    private String backgroundImage = null;
                                                    private Boolean sdCardStimuli = null;
                                                    private Boolean allowHotkeyButtons = null;
                                                    private String eraseUsersDataButtonlabel = null;
                                                    private String could_not_contact_the_server_please_check = null;
                                                    private String on_Error_Text = null;
                                                    private String retryButtonLabel = null;
                                                    private String helpText = null;
                                                
                                                    private Boolean generateCompletionCode = null;
                                                    private Boolean allowUserRestart = null;
                                                
                                                    @OneToMany(cascade = CascadeType.ALL, orphanRemoval = true, fetch = FetchType.LAZY)
                                                    private List<Metadata> metadataFields = null;
                                                    private Boolean useCodeVideo = null;
                                                    private String stimulusResponseOptions = null;
                                                    private String stimulusResponseLabelRight = null;
                                                    private String stimulusResponseLabelLeft = null;
                                                    private Boolean showProgress = null;
                                                    private StimuliSubAction[] stimuliSubActions = null;
                                                    private Boolean stimulusImageCapture = null;
                                                    private Integer taskIndex = null;-->
                                                <span th:replace="wizard :: wizardCheckBox(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='Centre Screen', wizardFragmentValue=${wizardScreen.centreScreen}, wizardFragmentName='centreScreen')"></span>
                                                <div th:each="screenText : ${wizardScreen.getScreenText()}">      
                                                    <span th:replace="wizard :: wizardTextArea(wizardScreenId=${wizardScreen.getId()}, screenTextId=${screenText.getId()}, wizardFragmentLabel=${wizardScreen.getWizardScreenType().wizardScreen.getScreenTextInfo(screenTextStat.index)}, wizardFragmentValue=${screenText.getScreenText()}, wizardFragmentName=${'screenText'+ screenText.getId()})"></span>
                                                </div>    
                                                <div th:each="nextButtonLabel : ${wizardScreen.nextButton}">      
                                                    <span th:replace="wizard :: wizardTextBox(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel=${wizardScreen.getWizardScreenType().wizardScreen.getNextButtonInfo(nextButtonLabelStat.index)}, wizardFragmentValue=${nextButtonLabel}, wizardFragmentName=${'nextButtonLabel'+nextButtonLabelStat.index})"></span>
                                                </div>                                                
                                                <div th:each="screenBoolean : ${wizardScreen.screenBooleans}">      
                                                    <span th:replace="wizard :: wizardCheckBox(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel=${wizardScreen.getWizardScreenType().wizardScreen.getScreenBooleanInfo(screenBooleanStat.index)}, wizardFragmentValue=${screenBoolean}, wizardFragmentName=${'screenBoolean'+screenBooleanStat.index})"></span>
                                                </div>                                                
                                                <!--<span th:replace="wizard :: wizardTextArea(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='Screen Text', wizardFragmentValue=${wizardScreen.screenText2}, wizardFragmentName='screenText2')"></span>-->
                                                <!--th:if="${wizardScreen.stimuli != null && wizardScreen.stimuli.size() > 0}"--> 
                                                <span th:if="${wizardScreen.canHaveStimuli()}">
                                                    <span th:replace="wizard :: wizardStimuliEditor(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='stimuliList', wizardFragmentValue=${wizardScreen.stimuli}, wizardFragmentName='stimuliList')"></span>
                                                </span>
                                                <span th:replace="wizard :: wizardTextArray(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='stimuliRandomTags', wizardFragmentValue=${wizardScreen.stimuliRandomTags}, wizardFragmentName='stimuliRandomTags')"></span>
                                                <!--<span th:replace="wizard :: wizardNumberBox(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='stimulusMsDelay', wizardFragmentValue=${wizardScreen.stimulusMsDelay}, wizardFragmentName='stimulusMsDelay')"></span>-->
                                                <!--<span th:replace="wizard :: wizardCheckBox(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='randomiseStimuli', wizardFragmentValue=${wizardScreen.randomiseStimuli}, wizardFragmentName='randomiseStimuli')"></span>-->
                                                <span th:replace="wizard :: wizardNumberBox(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='stimuliCount', wizardFragmentValue=${wizardScreen.stimuliCount}, wizardFragmentName='stimuliCount')"></span>
                                                <span th:replace="wizard :: wizardNumberBox(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='repeatCount', wizardFragmentValue=${wizardScreen.repeatCount}, wizardFragmentName='repeatCount')"></span>
                                                <span th:replace="wizard :: wizardNumberBox(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='repeatRandomWindow', wizardFragmentValue=${wizardScreen.repeatRandomWindow}, wizardFragmentName='repeatRandomWindow')"></span>
                                                <!--<span th:replace="wizard :: wizardCheckBox(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='useCodeVideo', wizardFragmentValue=${wizardScreen.useCodeVideo}, wizardFragmentName='useCodeVideo')"></span>-->
                                                <span th:replace="wizard :: wizardTextBox(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='stimulusResponseLabelLeft', wizardFragmentValue=${wizardScreen.stimulusResponseLabelLeft}, wizardFragmentName='stimulusResponseLabelLeft')"></span>
                                                <span th:replace="wizard :: wizardTextBox(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='stimulusResponseLabelRight', wizardFragmentValue=${wizardScreen.stimulusResponseLabelRight}, wizardFragmentName='stimulusResponseLabelRight')"></span>
                                                <!--<span th:replace="wizard :: wizardCheckBox(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='showProgress', wizardFragmentValue=${wizardScreen.showProgress}, wizardFragmentName='showProgress')"></span>-->                                                
                                                <span th:replace="wizard :: wizardTextBox(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='backgroundImage', wizardFragmentValue=${wizardScreen.backgroundImage}, wizardFragmentName='backgroundImage')"></span>
                                                <!--<span th:replace="wizard :: wizardCheckBox(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='sdCardStimuli', wizardFragmentValue=${wizardScreen.sdCardStimuli}, wizardFragmentName='sdCardStimuli')"></span>-->
                                                <!--<span th:replace="wizard :: wizardCheckBox(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='generateCompletionCode', wizardFragmentValue=${wizardScreen.generateCompletionCode}, wizardFragmentName='generateCompletionCode')"></span>-->    
                                                <!--<span th:replace="wizard :: wizardCheckBox(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='Allow User Restart', wizardFragmentValue=${wizardScreen.allowUserRestart}, wizardFragmentName='allowUserRestart')"></span>-->
                                                <span th:replace="wizard :: wizardTextBox(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='Group Members', wizardFragmentValue=${wizardScreen.groupMembers}, wizardFragmentName='groupMembers')"></span>
                                                <span th:replace="wizard :: wizardTextBox(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='Group Communication Channels', wizardFragmentValue=${wizardScreen.groupCommunicationChannels}, wizardFragmentName='groupCommunicationChannels')"></span>
                                                <span th:replace="wizard :: wizardTextArray(wizardScreenId=${wizardScreen.getId()}, wizardFragmentLabel='Group Phases Roles', wizardFragmentValue=${wizardScreen.groupPhasesRoles}, wizardFragmentName='groupPhasesRoles')"></span>
                                            </div>
                                            <div th:if="${wizardScreen.class.name == 'nl.mpi.tg.eg.experimentdesigner.model.wizard.WizardAboutScreen'}">WizardAboutScreen</div>
                                            <div th:if="${wizardScreen.class.name == 'nl.mpi.tg.eg.experimentdesigner.model.wizard.WizardAgreementScreen'}">WizardAgreementScreen</div>
                                            <div th:if="${wizardScreen.class.name == 'nl.mpi.tg.eg.experimentdesigner.model.wizard.WizardAudioRecorderMetadataScreen'}">
                                                <b>WizardAudioRecorderMetadataScreen</b><br/>
                                                <span>next_button</span><span><input class="wizardTextbox" name="next_button" th:value="${wizardScreen.next_button}" /></span><br/>
                                                <span>end_of_stimuli</span><span><input class="wizardTextbox" name="end_of_stimuli" th:value="${wizardScreen.end_of_stimuli}" /></span><br/>
                                                <div th:each="metadataString : ${wizardScreen.metadataStrings}">
                                                    <span>metadataStrings</span><span><textarea class="wizardTextbox" name="metadataStrings" th:text="${metadataString}" /></span><br/>
                                                </div>
                                            </div>
                                            <div th:if="${wizardScreen.class.name == 'nl.mpi.tg.eg.experimentdesigner.model.wizard.WizardAudioTestScreen'}">
                                                <b>WizardAudioTestScreen</b><br/>
                                                <span>audioPath</span><span><input class="wizardTextbox" name="audioPath" th:value="${wizardScreen.audioPath}" /></span><br/>
                                            </div>
                                            <div th:if="${wizardScreen.class.name == 'nl.mpi.tg.eg.experimentdesigner.model.wizard.WizardCompletionScreen'}">
                                                <b>WizardCompletionScreen</b>
                                                <!--                                                <span>completedText1</span><br/><span><span th:utext="${wizardScreen.completedText1}" /><textarea class="wizardTextbox" name="completedText1" th:text="${wizardScreen.completedText1}" /></span><br/>
                                                                                          Screen Text      <span>allowUserRestart</span><span><input type="checkbox" th:value="${wizardScreen.allowUserRestart}" /></span><br/>
                                                                                                <span>completedText2</span><br/><span><span th:utext="${wizardScreen.completedText2}" /><textarea class="wizardTextbox" name="completedText2" th:text="${wizardScreen.completedText2}" /></span><br/>
                                                                                                <span>eraseUsersDataButtonlabel</span><span><input class="wizardTextbox" name="eraseUsersDataButtonlabel" th:value="${wizardScreen.eraseUsersDataButtonlabel}" /></span><br/>
                                                                                                <span>could_not_contact_the_server_please_check</span><br/><span><span th:utext="${wizardScreen.could_not_contact_the_server_please_check}" /><textarea class="wizardTextbox" name="could_not_contact_the_server_please_check" th:text="${wizardScreen.could_not_contact_the_server_please_check}" /></span><br/>
                                                                                                <span>retryButtonLabel</span><span><input class="wizardTextbox" name="retryButtonLabel" th:value="${wizardScreen.retryButtonLabel}" /></span><br/>-->
                                            </div>
                                            <div th:if="${wizardScreen.class.name == 'nl.mpi.tg.eg.experimentdesigner.model.wizard.WizardEditUserScreen'}">
                                                <b>WizardEditUserScreen</b>
                                                <!--<span>metadataScreen</span><span><input type="checkbox" th:value="${wizardScreen.metadataScreen}" /></span><br/>-->
                                                <!--<span>metadataScreenText</span><br/><span><span th:utext="${wizardScreen.metadataScreenText}" /><textarea class="wizardTextbox" name="metadataScreenText" th:text="${wizardScreen.metadataScreenText}" /></span><br/>-->
                                                <!--<span>speakerNameField</span><span><input type="checkbox" th:value="${wizardScreen.speakerNameField}" /></span><br/>-->
                                                <!--<span>firstNameField</span><span><input type="checkbox" th:value="${wizardScreen.firstNameField}" /></span><br/>-->
                                                <!--<span>lastNameField</span><span><input type="checkbox" th:value="${wizardScreen.lastNameField}" /></span><br/>-->
                                                <!--                                                <span>genderField</span><span><input type="checkbox" th:value="${wizardScreen.genderField}" /></span><br/>
                                                                                                <span>emailAddressField</span><span><input type="checkbox" th:value="${wizardScreen.emailAddressField}" /></span><br/>
                                                                                                <span>customTextField</span><span><input class="wizardTextbox" name="customTextField" th:value="${wizardScreen.customTextField}" /></span><br/>
                                                                                                <span>optionCheckBox1</span><span><input class="wizardTextbox" name="optionCheckBox1" th:value="${wizardScreen.optionCheckBox1}" /></span><br/>
                                                                                                <span>optionCheckBox2</span><span><input class="wizardTextbox" name="optionCheckBox2" th:value="${wizardScreen.optionCheckBox2}" /></span><br/>
                                                                                                <span>mandatoryCheckBox</span><span><input class="wizardTextbox" name="mandatoryCheckBox" th:value="${wizardScreen.mandatoryCheckBox}" /></span><br/>
                                                                                                <span>ageField</span><span><input type="checkbox" th:value="${wizardScreen.ageField}" /></span><br/>-->
                                                <!--                                                <span th:each="customFieldString : ${wizardScreen.customFields}">
                                                                                                    <span>customFieldString</span><span><input class="wizardTextbox" name="customFields" th:value="${customFieldString}" /></span><br/>
                                                                                                </span>-->
                                                <!--<span>saveButtonLabel</span><span><input class="wizardTextbox" name="saveButtonLabel" th:value="${wizardScreen.saveButtonLabel}" /></span><br/>-->
                                                <!--<span>postText</span><br/><span><span th:utext="${wizardScreen.postText}" /><textarea class="wizardTextbox" name="postText" th:text="${wizardScreen.postText}" /></span><br/>-->
                                                private WizardScreen alternateNextScreen;
                                                <!--<span>alternateButtonLabel</span><span><input class="wizardTextbox" name="alternateButtonLabel" th:value="${wizardScreen.alternateButtonLabel}" /></span><br/>-->
                                                <!--<span>sendData</span><span><input type="checkbox" th:value="${wizardScreen.sendData}" /></span><br/>-->
                                                <!--<span>on_Error_Text</span><br/><span><span th:utext="${wizardScreen.on_Error_Text}" /><textarea class="wizardTextbox" name="on_Error_Text" th:text="${wizardScreen.on_Error_Text}" /></span><br/>-->
                                            </div>
                                            <div th:if="${wizardScreen.class.name == 'nl.mpi.tg.eg.experimentdesigner.model.wizard.WizardExistingUserCheckScreen'}">
                                                <b>WizardExistingUserCheckScreen</b>
                                                <span>new_Interview</span><span><input class="wizardTextbox" name="new_Interview" th:value="${wizardScreen.new_Interview}" /></span><br/>
                                                <span>resume_Interview</span><span><input class="wizardTextbox" name="resume_Interview" th:value="${wizardScreen.resume_Interview}" /></span><br/>
                                                <span>startNewText</span><span><input class="wizardTextbox" name="startNewText" th:value="${wizardScreen.startNewText}" /></span><br/>
                                                <span>resumeoldText</span><span><input class="wizardTextbox" name="resumeoldText" th:value="${wizardScreen.resumeoldText}" /></span><br/>
                                            </div>
                                            <div th:if="${wizardScreen.class.name == 'nl.mpi.tg.eg.experimentdesigner.model.wizard.WizardKinshipScreen'}">WizardKinshipScreen</div>
                                            <div th:if="${wizardScreen.class.name == 'nl.mpi.tg.eg.experimentdesigner.model.wizard.WizardMenuScreen'}">WizardMenuScreen</div>
                                            <div th:if="${wizardScreen.class.name == 'nl.mpi.tg.eg.experimentdesigner.model.wizard.WizardRandomStimulusScreen'}">WizardRandomStimulusScreen</div>
                                            <div th:if="${wizardScreen.class.name == 'nl.mpi.tg.eg.experimentdesigner.model.wizard.WizardScreen'}">WizardScreen</div>
                                            <div th:if="${wizardScreen.class.name == 'nl.mpi.tg.eg.experimentdesigner.model.wizard.WizardSelectUserScreen'}">WizardSelectUserScreen</div>
                                            <div th:if="${wizardScreen.class.name == 'nl.mpi.tg.eg.experimentdesigner.model.wizard.WizardStimulusScreen'}">WizardStimulusScreen</div>
                                            <div th:if="${wizardScreen.class.name == 'nl.mpi.tg.eg.experimentdesigner.model.wizard.WizardSubmitDataScreen'}">WizardSubmitDataScreen</div>
                                            <div th:if="${wizardScreen.class.name == 'nl.mpi.tg.eg.experimentdesigner.model.wizard.WizardTextScreen'}">
                                                <b>WizardTextScreen</b>
                                            </div>
                                            <div th:if="${wizardScreen.class.name == 'nl.mpi.tg.eg.experimentdesigner.model.wizard.WizardWelcomeScreen'}">WizardWelcomeScreen</div>
                                        </div>
                                        <!--<span th:text="${features.getFeatureText()}"></span>-->  
                                        <!--                                            <span class="td featurescell" th:if="${features.getFeatureType() ne null} and ${features.getFeatureType().canHaveText()}">
                                                                                        <textarea name="featureText" id="featureText" th:text="${features.getFeatureText()}" th:onchange="${'$(updateFeatureButton' + features.getId() + ').show();'}"></textarea>                                     
                                                                                    </span>
                                                                                    <span class="td">
                                                                                        <div class="featurescell" th:unless="${features.getFeatureType() eq null} or ${#lists.isEmpty(features.getFeatureType().getFeatureAttributes())}">
                                                                                            <table>
                                                                                                <tr th:each="featureattribute : ${features.getFeatureType().getFeatureAttributes()}" >
                                                                                                    <td th:text="${featureattribute.name()}">featureattribute.name()</td>
                                                                                                    <td>
                                                                                                        <input th:name="${featureattribute.name()}" th:value="${features.getFeatureAttributes(featureattribute.name())}" th:onchange="${'$(updateFeatureButton' + features.getId() + ').show();'}" />                                                            
                                                                                                    </td>
                                                                                                </tr>
                                                                                            </table>
                                                                                        </div>   
                                                                                    </span>
                                                                                    <span class="td">
                                                                                        <input type="number" th:value="${features.getDisplayOrder()}" name="displayOrder" th:onchange="${'$(updateFeatureButton' + features.getId() + ').show();'}"/>
                                                                                        <input type="hidden" th:value="${features.getId()}" name="id"/>
                                                                                        <input type="hidden" th:value="${features.getFeatureType()}" name="featureType"/>
                                                                                        <input type="hidden" th:name="${(objectType eq 'PresenterScreen')? 'screenId' : 'featureId'}" th:value="${presenterScreen.getId()}"/>
                                                                                    </span>-->
                                    </div>
                                    <!--<div th:replace="screens :: features(presenterScreen=${features}, objectType='PresenterFeature')"></div>-->
                                </div>
                            </div>
                        </div>
                        <!--                            <div class="addfeaturediv" th:if="(${objectType} eq 'PresenterScreen') or ${presenterScreen.getFeatureType() ne null and presenterScreen.getFeatureType().canHaveFeatures()}">
                                                        <form th:id="${'addForm' + objectType + presenterScreen.getId()}" method="post">
                                                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                                            <div class="errorDiv"/>
                                                            <select id="FeatureType" name="FeatureType">
                                                                <option th:each="featuretype : ${featuretypes}" th:value="${featuretype}" th:text="${featuretype}" />
                                                            </select>
                                                            <input th:if="${objectType} eq 'PresenterScreen'" type="hidden" name="screenId" th:value="${presenterScreen.getId()}" />
                                                            <input th:unless="${objectType} eq 'PresenterScreen'" type="hidden" name="featureId" th:value="${presenterScreen.getId()}" />
                                                            <button type="button" th:onclick="${'insertFeature(addForm' + objectType + presenterScreen.getId() + ')'}">Add Feature</button>
                                                        </form>
                                                    </div>-->
                    </div>
                    <div class="tr"></div>
                </div>
            </div>
            <script th:inline="javascript">
                /*<![CDATA[*/
                function startEditing(wizardFragmentName) {
                    $('#editButton' + wizardFragmentName).hide();
                    $('#editingPanel' + wizardFragmentName).show();
                }
                function cancelEditing(typeString, wizardFragmentName, wizardFragmentValue) {
//                    var targetUrl = /*[[${contextPath + '/wizard/update/'}]]*/'';
//                    $.get(targetUrl + typeString).done(function (data) {
//                        $('#editFragment' + wizardFragmentName).replaceWith(data);
//                    }).fail(function (data) {
//                        var jsonResponse = JSON.parse(data.responseText);
//                        $('#errorDiv' + wizardFragmentName).show();
//                        $('#errorDiv' + wizardFragmentName).text(jsonResponse.message);
//                    });
                    $('#editButton' + wizardFragmentName).show();
                    $('#editingPanel' + wizardFragmentName).hide();
                    $('#' + wizardFragmentName).val(wizardFragmentValue);

                }
                function saveEditing(typeString, wizardFragmentName) {
                    var targetUrl = /*[[${contextPath + '/wizard/update/'}]]*/'';
                    $.post(targetUrl + typeString, $('#editingForm' + wizardFragmentName).serialize()).done(function (data) {
                        $('#editFragment' + wizardFragmentName).replaceWith(data);
                    }).fail(function (data) {
                        var jsonResponse = JSON.parse(data.responseText);
                        $('#errorDiv' + wizardFragmentName).show();
                        $('#errorDiv' + wizardFragmentName).text(jsonResponse.message);
                    });
                }
                function hideShowDetails(wizardScreenTag)
                {
                    if ($('#wizardScreenDetailsCheckBox' + wizardScreenTag).is(":checked"))
                        $('#wizardScreenDetails' + wizardScreenTag).show();
                    else
                        $('#wizardScreenDetails' + wizardScreenTag).hide();
                }
                function hideShowStimuliDetails(wizardScreenId)
                {
                    if ($('#editStimuliDetailsCheckBox' + wizardScreenId).is(":checked")) {
                        $('#editStimuliPanel' + wizardScreenId).show();
                        $('#displayStimuliPanel' + wizardScreenId).hide();
                    } else {
                        $('#editStimuliPanel' + wizardScreenId).hide();
                        $('#displayStimuliPanel' + wizardScreenId).show();
                    }
                }
                function allowDrop(ev) {
                    ev.preventDefault();
                }

                function drag(ev) {
                    ev.dataTransfer.setData("text", ev.target.id);
                }

                function drop(ev) {
                    ev.preventDefault();
                    var data = ev.dataTransfer.getData("text");
                    var list = document.getElementById("wizardScreenList");
                    list.insertBefore(document.getElementById(data), ev.target);
                }
                function stimulusDragEnter(event, wizardScreenId)
                {
                    event.stopPropagation();
                    event.preventDefault();
                    $('#stimulusUploadBox' + wizardScreenId).addClass("stimulusUploadBoxActive");
                }
                function stimulusDragOver(event, wizardScreenId)
                {
                    event.stopPropagation();
                    event.preventDefault();
                }
                function stimulusDragLeave(event, wizardScreenId)
                {
                    event.stopPropagation();
                    event.preventDefault();
                    $('#stimulusUploadBox' + wizardScreenId).removeClass("stimulusUploadBoxActive");
                }
                function stimulusDrop(event, wizardScreenId)
                {
                    event.stopPropagation();
                    event.preventDefault();
                    $('#stimulusUploadBox' + wizardScreenId).removeClass("stimulusUploadBoxActive");
                    //                    console.log(event);
                    //                    console.log(event.dataTransfer);
                    //                    console.log(event.dataTransfer.files);
                    checkFiles(event.dataTransfer.files, wizardScreenId);
                }
                function checkFiles(droppedFiles, wizardScreenId) {
                    for (var fileIndex = 0; fileIndex < droppedFiles.length; fileIndex++) {
                        console.log(droppedFiles[fileIndex].type);
                        console.log(droppedFiles[fileIndex].size);
                        console.log(droppedFiles[fileIndex].name);
                        if (droppedFiles[fileIndex].type === "image/jpeg"
                                || droppedFiles[fileIndex].type === "image/png") {
                            uploadFile(droppedFiles[fileIndex], wizardScreenId);
                        } else {
                            $("<div class='errorDiv'>" + droppedFiles[fileIndex].type + " not supported</div>").insertAfter('#stimulusUploadBox' + wizardScreenId);
                        }
                    }
                }

                function uploadFile(fileToUpload, wizardScreenId) {
                    if (typeof FileReader !== "undefined") {
                        var xhRequest = new XMLHttpRequest();
                        var contextPath = /*[[${contextPath}]]*/ 'contextPath';
                        xhRequest.open("post", contextPath + "/wizard/" + wizardScreenId + "/stimulus/" + fileToUpload.name + "/" + fileToUpload.type + "/upload", true);
                        var progressDivBar = $("<div class='progressDivBar'>&nbsp;</div>");
                        var progressDivLabel = $("<div class='progressDivLabel'>" + fileToUpload.name + "</div>");
                        var progressDivOuter = $("<div class='progressDivOuter'></div>");
                        progressDivBar.css("width", "0%");
                        progressDivOuter.append(progressDivBar);
                        progressDivOuter.append(progressDivLabel);
                        progressDivOuter.insertAfter('#stimulusUploadBox' + wizardScreenId);
                        xhRequest.upload.addEventListener("progress", function (event) {
                            console.log(event);
                            if (event.lengthComputable) {
                                progressDivBar.css("width", (event.loaded / event.total) * 100 + "%");
                                progressDivLabel.html(" " + ((event.loaded / event.total) * 100).toFixed() + "% " + fileToUpload.name);
                            } else {
                                progressDivLabel.html("unknown % " + fileToUpload.name);
                            }
                        }, false);
                        xhRequest.onreadystatechange = function (oEvent) {
                            if (xhRequest.readyState === 4) {
                                if (xhRequest.status === 200) {
                                    //                                    progressDivBar.css("width", "100%");
                                    //                                    progressDivLabel.html("100% " + fileToUpload.name);
                                    $(xhRequest.responseText).insertAfter(progressDivOuter);
                                    progressDivOuter.hide();
                                } else {
                                    progressDivLabel.html("Error: " + xhRequest.statusText + " " + fileToUpload.name);
                                }
                            }
                        };
                        var csrfParameterName = /*[[${_csrf.token}]]*/ 'csrfParameterName';
                        xhRequest.setRequestHeader("X-CSRF-TOKEN", csrfParameterName);
                        xhRequest.setRequestHeader("X-File-Name", fileToUpload.name);
                        xhRequest.setRequestHeader("X-File-Size", fileToUpload.size);
                        xhRequest.setRequestHeader("X-File-Type", fileToUpload.type);
                        var formData = new FormData();
                        formData.append('stimulusFile', fileToUpload);
                        xhRequest.send(formData);
                    } else {
                        $("<div class='errorDiv'>Browser not supported</div>").insertAfter('#stimulusUploadBox' + wizardScreenId);
                    }
                }
                /*]]>*/
            </script>
        </div>
        <div style="border: black;border-style: solid;padding: 10px;">
            <span th:fragment="wizardCheckBox(wizardScreenId, wizardFragmentLabel, wizardFragmentValue, wizardFragmentName)">
                <div class="featuresrow featurescell" th:if="${wizardFragmentValue != null}">
                    <span th:text="${wizardFragmentLabel}">wizardCheckBox</span>
                    <input type="checkbox" th:checked="${wizardFragmentValue}" th:name="${wizardFragmentName}" th:onchange="${'$(updateFeatureButton' + wizardScreenId + ').show();'}" />
                    <br/>
                </div>
            </span>
            <span th:fragment="wizardNumberBox(wizardScreenId, wizardFragmentLabel, wizardFragmentValue, wizardFragmentName)">
                <div class="featuresrow featurescell" th:if="${wizardFragmentValue != null}">
                    <span th:text="${wizardFragmentLabel}">wizardNumberBox</span>
                    <input type="number" th:value="${wizardFragmentValue}" th:name="${wizardFragmentName}" />
                    <br/>
                </div>
            </span>
            <span th:fragment="wizardTextBox(wizardScreenId, wizardFragmentLabel, wizardFragmentValue, wizardFragmentName)">
                <div class="featuresrow featurescell wizardrow" th:if="${wizardFragmentValue != null}">
                    <span class="wizardcell" th:text="${wizardFragmentLabel}">wizardTextBox</span>
                    <input th:value="${wizardFragmentValue}" class="wizardgrowcell" th:name="${wizardFragmentName}" th:onchange="${'$(updateFeatureButton' + wizardScreenId + ').show();'}" />
                    <br/>
                </div>
            </span>
            <span th:id="${'editFragment' + wizardFragmentName}" th:fragment="wizardTextArea(wizardScreenId, screenTextId, wizardFragmentLabel, wizardFragmentValue, wizardFragmentName)">
                <div class="featuresrow" th:if="${wizardFragmentValue != null}">
                    <div class="featureTypeHeader">
                        <span class="featurescell" th:text="${wizardFragmentLabel}">wizardTextArea</span>
                    </div>
                    <div class="featurescell">
                        <span th:utext="${wizardFragmentValue}" />
                        <button type="button" class="wizardScreenEditCheckBox" th:id="${'editButton' + wizardFragmentName}" th:onclick="'startEditing(\'' + ${wizardFragmentName} + '\');'">Edit</button>
                        <div th:id="${'editingPanel' + wizardFragmentName}" style="display: none">
                            <form th:id="${'editingForm' + wizardFragmentName}">
                                <textarea class="wizardTextbox" th:id="${wizardFragmentName}" th:name="screenText" th:text="${wizardFragmentValue}">
                                </textarea>
                                <input type="hidden" name="wizardData" th:value="${wizardData.getId()}" />
                                <input type="hidden" name="wizardScreenId" th:value="${wizardScreenId}" />
                                <input type="hidden" name="screenTextId" th:value="${screenTextId}" />
                                <input type="hidden" name="wizardFragmentLabel" th:value="${wizardFragmentLabel}" />
                                <input type="hidden" name="wizardFragmentName" th:value="${wizardFragmentName}" />
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            </form>
                            <br/>
                            <span class="wizardScreenEditCheckBox">
                                <button type="button" th:id="${'cancelEditingButton' + wizardFragmentName}" th:onclick="'cancelEditing(\'screenText\',\'' + ${wizardFragmentName} + '\',\'' + ${wizardFragmentValue} + '\');'">Cancel</button>
                                &nbsp;
                                <button type="button" th:id="${'saveEditingButton' + wizardFragmentName}" th:onclick="'saveEditing(\'screenText\',\'' + ${wizardFragmentName} + '\');'">Save Changes</button>
                            </span>
                        </div>
                        <div class="errorDiv" th:id="${'errorDiv' + wizardFragmentName}" style="display: none" />
                    </div>
                    <br/>
                </div>
            </span>
            <span th:fragment="wizardTextArray(wizardScreenId, wizardFragmentLabel, wizardFragmentValue, wizardFragmentName)">
                <div class="featuresrow" th:if="${wizardFragmentValue != null}">
                    <div class="featureTypeHeader">
                        <span class="featurescell" th:text="${wizardFragmentLabel}">wizardTextArea</span>
                    </div>
                    <div class="featurescell">
                        <span th:each="wizardFragmentItem : ${wizardFragmentValue}">
                            <input class="wizardTextbox" th:value="${wizardFragmentItem}" th:name="${wizardFragmentName}" th:onchange="${'$(updateFeatureButton' + wizardScreenId + ').show();'}"/>
                            <br/>
                        </span>
                    </div>
                    <br/>
                </div>
            </span>
            <span th:fragment="wizardStimuliEditor(wizardScreenId, wizardFragmentLabel, wizardFragmentValue, wizardFragmentName)">
                <div class="featuresrow" th:if="${wizardFragmentValue != null}">
                    <div class="featureTypeHeader">
                        <span class="featurescell" th:text="${wizardFragmentLabel}">wizardTextArea</span>
                    </div>
                    &nbsp;<span class="wizardScreenDetailsCheckBox"><input type="checkbox" th:id="${'editStimuliDetailsCheckBox' + wizardScreen.id}" th:onclick="'hideShowStimuliDetails(\''+${wizardScreen.id}+'\')'">Show details</input></span>
                    <div class="stimulusUploadBox" th:id="${'stimulusUploadBox' + wizardScreen.id}" 
                         th:ondragover="${'stimulusDragOver(event, ' + wizardScreen.id + ');'}"
                         th:ondragenter="${'stimulusDragEnter(event, ' + wizardScreen.id + ');'}"
                         th:ondragleave="${'stimulusDragLeave(event, ' + wizardScreen.id + ');'}"
                         th:ondrop="${'stimulusDrop(event, ' + wizardScreen.id + ');'}"
                         >
                        <b>Drag and drop stimulus files here.</b><br/>
                        Stimuli are identified by their file name, so an existing stimulus can be updated providing that the uploaded file name matches the stimulus identifier.<br/>
                        The file name also sets the "label", "code", "pause ms" and "stimulus tags" providing it is in the following format:<br/>
                        label_code_pauseMs_stimulusTags.suffix<br/>
                        For example: "house__1000_building_big_home.jpg" would create or update one stimulus with identifier "house__1000_building_big_home.jpg", the label "house", without a code, a 1 second delay and three tags "building", "big", "home".<br/>
                    </div>
                    <div class="featurescell" th:id="${'displayStimuliPanel' + wizardScreen.id}">
                        <!--<button type="button" class="wizardScreenEditCheckBox" th:onclick="${'$(editStimuliPanel' + wizardScreenId + ').show(); $(displayStimuliPanel' + wizardScreenId + ').hide();'}">Edit Stimuli</button>-->
                        <span th:each="stimulus : ${wizardFragmentValue}" th:text="${stimulus.identifier + '&nbsp;'}"></span>
                    </div>
                    <div class="featurescell" th:id="${'editStimuliPanel' + wizardScreen.id}" style="display: none">
                        <!--<button type="button" class="deleteFeatureButton" th:onclick="${'$(editStimuliPanel' + wizardScreenId + ').hide(); $(displayStimuliPanel' + wizardScreenId + ').show();'}">Close</button>-->
                        <!--<span th:each="wizardFragmentItem : ${wizardFragmentValue}">-->
                        <!--<input class="wizardTextbox" th:value="${wizardFragmentItem}" th:name="${wizardFragmentName}" th:onchange="${'$(updateFeatureButton' + wizardScreenId + ').show();'}"/>-->
                        <!--<br/>-->
                        <!--</span>-->
                        <div th:include="stimuli :: stimulitable(stimuliList=${wizardFragmentValue}, parentId=${wizardScreenId}, parentType='wizard')"></div>
                    </div>
                    <br/>
                </div>
            </span>
        </div>
    </body>
</html>
